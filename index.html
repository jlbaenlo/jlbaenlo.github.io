<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <title>Triateur de Playlists Spotify</title>
    <style>
        body {
            font-family: Arial;
            padding: 20px;
        }

        button {
            padding: 10px 15px;
            margin: 10px 0;
        }

        select {
            padding: 5px;
            width: 300px;
        }
    </style>
</head>

<body>

    <h1>Triateur de Playlists Spotify ðŸª©</h1>
    <p>1. Connectez-vous<br>2. Choisissez une playlist<br>3. Cliquez pour crÃ©er une version triÃ©e</p>

    <button id="loginBtn">Se connecter avec Spotify</button>

    <div id="app" style="display:none;">

        <h3>Vos playlists :</h3>
        <select id="playlistSelect"></select>
        <br><br>

        <button id="sortBtn">CrÃ©er playlist triÃ©e</button>

        <p id="status"></p>

    </div>

    <script>
        // ------------------------------------------------------
        // CONFIG
        // ------------------------------------------------------
        const clientId = "1795fe450d3a4f6ebe2ce1cdcfbc21bf";  // <-- Ã  remplacer

        // On normalise l'URI pour Ã©viter les soucis de "index.html" vs "/"
        // Cela enlÃ¨ve "index.html" s'il est prÃ©sent, et s'assure qu'on garde le dossier racine.
        let redirectUri = window.location.origin + window.location.pathname;
        if (redirectUri.endsWith("index.html")) {
            redirectUri = redirectUri.substring(0, redirectUri.length - "index.html".length);
        }
        // On s'assure qu'il n'y a pas de double slash Ã  la fin (sauf si c'est juste https://...)
        if (!redirectUri.endsWith("/")) {
            // Si c'est un dossier, on ajoute souvent un slash, mais attention aux fichiers.
            // Dans le doute pour GitHub Pages, le root est souvent avec un slash.
            // On va laisser tel quel si Ã§a ne finit pas par index.html, 
            // mais si l'utilisateur est sur /test, Ã§a reste /test.
        }

        // AFFICHER L'URI POUR DEBUG AVEC BOUTON COPIER
        const debugContainer = document.createElement("div");
        debugContainer.style.background = "#f0f0f0";
        debugContainer.style.border = "1px solid #ccc";
        debugContainer.style.padding = "15px";
        debugContainer.style.margin = "20px 0";
        debugContainer.style.borderRadius = "5px";

        const debugTitle = document.createElement("strong");
        debugTitle.textContent = "âš ï¸ CONFIGURATION REQUISE :";
        debugContainer.appendChild(debugTitle);

        const debugText = document.createElement("p");
        debugText.innerHTML = `Ajoutez cette URI exacte dans votre Dashboard Spotify (<a href='https://developer.spotify.com/dashboard' target='_blank'>lien</a>) :`;
        debugContainer.appendChild(debugText);

        const codeBlock = document.createElement("code");
        codeBlock.style.display = "block";
        codeBlock.style.background = "#fff";
        codeBlock.style.padding = "10px";
        codeBlock.style.border = "1px solid #ddd";
        codeBlock.style.margin = "10px 0";
        codeBlock.style.wordBreak = "break-all";
        codeBlock.textContent = redirectUri;
        debugContainer.appendChild(codeBlock);

        const copyBtn = document.createElement("button");
        copyBtn.textContent = "Copier l'URI";
        copyBtn.onclick = () => {
            navigator.clipboard.writeText(redirectUri).then(() => {
                copyBtn.textContent = "CopiÃ© ! âœ…";
                setTimeout(() => copyBtn.textContent = "Copier l'URI", 2000);
            });
        };
        debugContainer.appendChild(copyBtn);

        const details = document.createElement("small");
        details.style.display = "block";
        details.style.marginTop = "10px";
        details.style.color = "#666";
        details.textContent = `(Longueur: ${redirectUri.length} caractÃ¨res. Assurez-vous qu'il n'y a pas d'espace en trop dans le Dashboard)`;
        debugContainer.appendChild(details);

        document.body.insertBefore(debugContainer, document.getElementById("loginBtn"));

        // Scopes nÃ©cessaires
        const scope = [
            "playlist-read-private",
            "playlist-modify-private",
            "playlist-modify-public"
        ].join(" ");

        let accessToken = null;

        // ------------------------------------------------------
        // 1. LOGIN
        // ------------------------------------------------------
        document.getElementById("loginBtn").onclick = () => {
            const params = new URLSearchParams({
                client_id: clientId.trim(),
                response_type: "token",
                redirect_uri: redirectUri,
                scope: scope
            });
            const authUrl = "https://accounts.spotify.com/authorize?" + params.toString();

            console.log("Navigating to:", authUrl); // Debug
            window.location = authUrl;
        };

        // ------------------------------------------------------
        // 2. TRAITEMENT DU TOKEN APRES REDIRECTION
        // ------------------------------------------------------
        if (window.location.hash.includes("access_token")) {
            accessToken = new URLSearchParams(window.location.hash.substring(1)).get("access_token");

            document.getElementById("loginBtn").style.display = "none";
            document.getElementById("app").style.display = "block";

            loadPlaylists();
        }

        // ------------------------------------------------------
        // 3. CHARGER LES PLAYLISTS
        // ------------------------------------------------------
        async function loadPlaylists() {
            const resp = await fetch("https://api.spotify.com/v1/me/playlists", {
                headers: { Authorization: "Bearer " + accessToken }
            });
            const data = await resp.json();

            const select = document.getElementById("playlistSelect");
            data.items.forEach(pl => {
                const opt = document.createElement("option");
                opt.value = pl.id;
                opt.textContent = pl.name;
                select.appendChild(opt);
            });
        }

        // ------------------------------------------------------
        // 4. TRI DES TITRES + CREATION NOUVELLE PLAYLIST
        // ------------------------------------------------------
        document.getElementById("sortBtn").onclick = async () => {
            const playlistId = document.getElementById("playlistSelect").value;
            document.getElementById("status").textContent = "RÃ©cupÃ©ration de la playlistâ€¦";

            // 4.1 rÃ©cupÃ©rer les morceaux
            const tracks = await fetch(`https://api.spotify.com/v1/playlists/${playlistId}/tracks`, {
                headers: { Authorization: "Bearer " + accessToken }
            }).then(r => r.json());

            const uris = tracks.items.map(t => t.track.uri);

            // 4.2 rÃ©cupÃ©rer l'audio features pour trier
            const ids = tracks.items.map(t => t.track.id).join(",");
            const audio = await fetch(`https://api.spotify.com/v1/audio-features?ids=${ids}`, {
                headers: { Authorization: "Bearer " + accessToken }
            }).then(r => r.json());

            // 4.3 trier : par danceability croissante (modifiable)
            const sorted = audio.audio_features
                .map((f, i) => ({ uri: uris[i], danceability: f?.danceability || 0 }))
                .sort((a, b) => a.danceability - b.danceability);

            // 4.4 crÃ©er une nouvelle playlist
            const me = await fetch("https://api.spotify.com/v1/me", {
                headers: { Authorization: "Bearer " + accessToken }
            }).then(r => r.json());

            const newPlaylist = await fetch(`https://api.spotify.com/v1/users/${me.id}/playlists`, {
                method: "POST",
                headers: {
                    Authorization: "Bearer " + accessToken,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    name: "Playlist TriÃ©e ðŸ’¿",
                    description: "CrÃ©Ã©e automatiquement",
                    public: false
                })
            }).then(r => r.json());

            // 4.5 ajouter les morceaux triÃ©s
            await fetch(`https://api.spotify.com/v1/playlists/${newPlaylist.id}/tracks`, {
                method: "POST",
                headers: {
                    Authorization: "Bearer " + accessToken,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    uris: sorted.map(s => s.uri)
                })
            });

            document.getElementById("status").textContent =
                "ðŸŽ‰ Playlist triÃ©e crÃ©Ã©e : " + newPlaylist.name;
        };
    </script>

</body>

</html>